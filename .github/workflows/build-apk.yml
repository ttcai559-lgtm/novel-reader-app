name: Build Android APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:  # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Prepare mobile app
      run: |
        cd mobile_app
        # Copy dependencies if they exist
        cp -r ../modules . 2>/dev/null || true
        cp -r ../core . 2>/dev/null || true
        cp -r ../config . 2>/dev/null || true
        cp ../novel_to_audio.py . 2>/dev/null || true
        ls -la

    - name: Build APK with Buildozer Docker
      run: |
        cd mobile_app
        docker run --rm -v "$PWD":/home/user/hostcwd \
          kivy/buildozer:latest \
          android debug
      timeout-minutes: 60

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: novelreader-apk
        path: mobile_app/bin/*.apk

    - name: Upload build logs (if failed)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: mobile_app/.buildozer/
